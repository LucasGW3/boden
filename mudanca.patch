 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/safra_dashboard.php b/safra_dashboard.php
index d9b34ba44bb6d462094c73c770837496ebe3479b..296c2f70e96030d358da62e95510d78137184996 100644
--- a/safra_dashboard.php
+++ b/safra_dashboard.php
@@ -728,293 +728,204 @@ foreach (array_keys($byDay) as $d) {
 if ($valsForAvg) $atingMetaMedia = round(array_sum($valsForAvg) / count($valsForAvg), 2);
 $atingSafraPct = ($totalMetaSafra > 0) ? round(($totalRealSafra / $totalMetaSafra) * 100, 2) : null;
 
 /* =============================================================================
  * 7) Comercial — HOJE e ONTEM (média diária por SC)
  * ========================================================================== */
 $cStmt = pdo()->prepare("
   SELECT ref_date, payload_json
   FROM safra_entries
   WHERE ref_date >= :from AND ref_date < DATE_ADD(:to, INTERVAL 1 DAY)
     AND (:u1 = '' OR unidade = :u2)
   {$restrictUnitsSQL}
   ORDER BY ref_date ASC, id ASC
 ");
 $cParams = array_merge([
   ':from' => $from->format('Y-m-d'),
   ':to'   => $to->format('Y-m-d'),
   ':u1'   => $unidade,
   ':u2'   => $unidade,
 ], $paramsUnits);
 $cStmt->execute($cParams ?: []);
 
 /* mapas por dia */
 $comHojeByDate  = []; // [Y-m-d] => ['sum'=>..., 'cnt'=>...]
 $comOntemByDate = [];
+$comHojeByBox   = []; // [Caixa][Y-m-d] => ['sum'=>..., 'cnt'=>...]
+$comOntemByBox  = [];
+$comBoxSet      = [];
 
 while ($row = $cStmt->fetch(PDO::FETCH_ASSOC)) {
   $d = $row['ref_date'];
   $payload = json_decode($row['payload_json'], true) ?: [];
   $vendas  = $payload['comercial']['vendas'] ?? [];
 
   if (!isset($comHojeByDate[$d]))  $comHojeByDate[$d]  = ['sum'=>0.0,'cnt'=>0];
   if (!isset($comOntemByDate[$d])) $comOntemByDate[$d] = ['sum'=>0.0,'cnt'=>0];
 
   // normaliza $vendas (aceita array associativo ou lista)
   if (is_array($vendas) && array_keys($vendas) !== range(0, count($vendas)-1)) {
     // se vier objeto/dicionário, transforma em lista de itens
     $vendas = array_values($vendas);
   }
 
   if (!is_array($vendas)) continue;
 
   foreach ($vendas as $v) {
     if (!is_array($v)) continue;
 
+    $caixaRaw = $v['caixa']
+      ?? $v['caixa_nome']
+      ?? $v['tipo_caixa']
+      ?? $v['caixa_tipo']
+      ?? $v['tipo']
+      ?? null;
+    if (is_array($caixaRaw)) {
+      $caixaRaw = $caixaRaw['nome'] ?? $caixaRaw['label'] ?? null;
+    }
+    $caixa = trim((string)$caixaRaw);
+    if ($caixa === '') $caixa = 'Caixa';
+    $comBoxSet[$caixa] = true;
+
     // ----- valores de HOJE (qualquer uma das chaves abaixo)
     $candidatosHoje = [
       $v['preco']        ?? null,
       $v['preco_hoje']   ?? null,
       $v['preco_sc']     ?? null,
       $v['preco_atual']  ?? null,
     ];
     foreach ($candidatosHoje as $raw) {
       $num = parse_money_br($raw);
       if ($num !== null && $num > 0) {
         $comHojeByDate[$d]['sum'] += $num;
         $comHojeByDate[$d]['cnt'] += 1;
+
+        if (!isset($comHojeByBox[$caixa])) $comHojeByBox[$caixa] = [];
+        if (!isset($comHojeByBox[$caixa][$d])) $comHojeByBox[$caixa][$d] = ['sum' => 0.0, 'cnt' => 0];
+        $comHojeByBox[$caixa][$d]['sum'] += $num;
+        $comHojeByBox[$caixa][$d]['cnt'] += 1;
+
         break; // considera uma por item
       }
     }
 
     // ----- valores de ONTEM (qualquer uma das chaves abaixo)
     $candidatosOntem = [
       $v['preco_ontem']       ?? null,
       $v['preco_realizado']   ?? null,
       $v['preco_sc_ontem']    ?? null,
     ];
     foreach ($candidatosOntem as $raw) {
       $num = parse_money_br($raw);
       if ($num !== null && $num > 0) {
         $comOntemByDate[$d]['sum'] += $num;
         $comOntemByDate[$d]['cnt'] += 1;
+
+        if (!isset($comOntemByBox[$caixa])) $comOntemByBox[$caixa] = [];
+        if (!isset($comOntemByBox[$caixa][$d])) $comOntemByBox[$caixa][$d] = ['sum' => 0.0, 'cnt' => 0];
+        $comOntemByBox[$caixa][$d]['sum'] += $num;
+        $comOntemByBox[$caixa][$d]['cnt'] += 1;
+
         break;
       }
     }
   }
 }
 
 ksort($comHojeByDate);
 ksort($comOntemByDate);
 
 // HOJE
 $labelsC_H = [];
 $avgPerSC_H = [];
 $totalSumH = 0.0; $totalCntH = 0;
 foreach ($comHojeByDate as $dateYmd => $vals) {
   $labelsC_H[] = (new DateTime($dateYmd))->format('d/m');
   $dia = ($vals['cnt']>0) ? round($vals['sum']/$vals['cnt'], 3) : null;
   $avgPerSC_H[] = $dia;
   if ($dia !== null) { $totalSumH += $dia; $totalCntH++; }
 }
 $mediaPeriodoSC_H = $totalCntH>0 ? round($totalSumH/$totalCntH, 3) : null;
 
 // ONTEM
 $labelsC_O = [];
 $avgPerSC_O = [];
 $totalSumO = 0.0; $totalCntO = 0;
 foreach ($comOntemByDate as $dateYmd => $vals) {
   $labelsC_O[] = (new DateTime($dateYmd))->format('d/m');
   $dia = ($vals['cnt']>0) ? round($vals['sum']/$vals['cnt'], 3) : null;
   $avgPerSC_O[] = $dia;
   if ($dia !== null) { $totalSumO += $dia; $totalCntO++; }
 }
 $mediaPeriodoSC_O = $totalCntO>0 ? round($totalSumO/$totalCntO, 3) : null;
 
 /* ISO para filtragem no client */
 $labelsCISO_H = array_keys($comHojeByDate);
 $labelsCISO_O = array_keys($comOntemByDate);
 
-/* === Comercial por Variedade via VIEWS (Hoje/Ontem) === */
-
-/* 1) Variedades disponíveis no período/unidade */
-$sqlVar = "
-  SELECT DISTINCT vp.variedade
-  FROM v_precos_comercial_var_ponderado vp
-  WHERE vp.ref_date BETWEEN :from AND :to
-    AND (
-      :u1 = '' OR EXISTS (
-        SELECT 1
-          FROM v_comercial_vendas cv
-         WHERE cv.ref_date  = vp.ref_date
-           AND cv.variedade = vp.variedade
-           AND cv.unidade   = :u2
-      )
-    )
-  ORDER BY vp.variedade
-";
-$stVar = pdo()->prepare($sqlVar);
-$stVar->execute([
-  ':from' => $from->format('Y-m-d'),
-  ':to'   => $to->format('Y-m-d'),
-  ':u1'   => $unidade,
-  ':u2'   => $unidade,
-]);
-$comVarNames = $stVar->fetchAll(PDO::FETCH_COLUMN) ?: [];
-
-/* 2) Índices por data (já vieram dos blocos HOJE/ONTEM) */
-$idxByDateH = array_flip($labelsCISO_H); // HOJE
-$idxByDateO = array_flip($labelsCISO_O); // ONTEM
-
-/* 3) Pesos (SC) por dia e variedade — romaneio */
-$sqlW = "
-  SELECT
-    p.ref_date,
-    p.variedade,
-    SUM(p.peso_sc) AS sc
-  FROM v_romaneio_var_caixa_peso p
-  JOIN v_comercial_vendas cv
-    ON  cv.ref_date  = p.ref_date
-    AND cv.variedade = p.variedade
-    AND cv.caixa     = p.caixa
-  WHERE p.ref_date >= :from AND p.ref_date < DATE_ADD(:to, INTERVAL 1 DAY)
-    AND (:u1 = '' OR cv.unidade = :u2)
-  GROUP BY p.ref_date, p.variedade
-";
-$stW = pdo()->prepare($sqlW);
-$stW->execute([
-  ':from' => $from->format('Y-m-d'),
-  ':to'   => $to->format('Y-m-d'),
-  ':u1'   => $unidade,
-  ':u2'   => $unidade,
-]);
-
-/* 4) Preços HOJE (média por dia/variedade) */
-$sqlPH = "
-  SELECT vp.ref_date, vp.variedade, vp.preco_ponderado_sc AS preco
-  FROM v_precos_comercial_var_ponderado vp
-  WHERE vp.ref_date BETWEEN :from AND :to
-    AND vp.preco_ponderado_sc IS NOT NULL
-    AND (
-      :u1 = '' OR EXISTS (
-        SELECT 1
-          FROM v_comercial_vendas cv
-         WHERE cv.ref_date  = vp.ref_date
-           AND cv.variedade = vp.variedade
-           AND cv.unidade   = :u2
-      )
-    )
-";
-$stPH = pdo()->prepare($sqlPH);
-$stPH->execute([
-  ':from' => $from->format('Y-m-d'),
-  ':to'   => $to->format('Y-m-d'),
-  ':u1'   => $unidade,
-  ':u2'   => $unidade,
-]);
-
-/* 5) Preços ONTEM (ponderado por caixa, inlinee) */
-$sqlPO = "
-  SELECT
-    p.ref_date,
-    p.variedade,
-    CASE WHEN SUM(p.peso_sc) > 0
-         THEN SUM(p.peso_sc * cv.preco_ontem) / SUM(p.peso_sc)
-         ELSE NULL
-    END AS preco
-  FROM v_romaneio_var_caixa_peso p
-  JOIN v_comercial_vendas cv
-    ON  cv.ref_date  = p.ref_date
-    AND cv.variedade = p.variedade
-    AND cv.caixa     = p.caixa
-  WHERE p.ref_date >= :from AND p.ref_date < DATE_ADD(:to, INTERVAL 1 DAY)
-    AND (:u1 = '' OR cv.unidade = :u2)
-    AND cv.preco_ontem IS NOT NULL
-  GROUP BY p.ref_date, p.variedade
-";
-$stPO = pdo()->prepare($sqlPO);
-$stPO->execute([
-  ':from' => $from->format('Y-m-d'),
-  ':to'   => $to->format('Y-m-d'),
-  ':u1'   => $unidade,
-  ':u2'   => $unidade,
-]);
-
-/* 6) Inicializa arrays alinhados às datas HOJE/ONTEM */
-$lenH = count($labelsCISO_H);
-$lenO = count($labelsCISO_O);
-$comHojeVarPrice  = [];
-$comHojeVarQty    = [];
-$comOntemVarPrice = [];
-$comOntemVarQty   = [];
-
-foreach ($comVarNames as $vn) {
-  $comHojeVarPrice[$vn]  = array_fill(0, $lenH, null);
-  $comHojeVarQty[$vn]    = array_fill(0, $lenH, 0.0);
-  $comOntemVarPrice[$vn] = array_fill(0, $lenO, null);
-  $comOntemVarQty[$vn]   = array_fill(0, $lenO, 0.0);
-}
-
-/* 7) Preenche preços HOJE */
-while ($r = $stPH->fetch(PDO::FETCH_ASSOC)) {
-  $d  = $r['ref_date'];
-  $vn = (string)$r['variedade'];
-  $pr = is_numeric($r['preco']) ? (float)$r['preco'] : null;
-  if ($pr === null || !isset($idxByDateH[$d]) || !isset($comHojeVarPrice[$vn])) continue;
-  $i = $idxByDateH[$d];
-  $comHojeVarPrice[$vn][$i] = $pr;
-}
-
-/* 8) Preenche preços ONTEM */
-while ($r = $stPO->fetch(PDO::FETCH_ASSOC)) {
-  $d  = $r['ref_date'];
-  $vn = (string)$r['variedade'];
-  $pr = is_numeric($r['preco']) ? (float)$r['preco'] : null;
-  if ($pr === null || !isset($idxByDateO[$d]) || !isset($comOntemVarPrice[$vn])) continue;
-  $i = $idxByDateO[$d];
-  $comOntemVarPrice[$vn][$i] = $pr;
+$comBoxNames = array_keys($comBoxSet);
+natcasesort($comBoxNames);
+$comBoxNames = array_values($comBoxNames);
+
+$comHojeBoxSeries = [];
+$comHojeBoxCount  = [];
+foreach ($comBoxNames as $boxName) {
+  $series = [];
+  $counts = [];
+  foreach ($labelsCISO_H as $dateYmd) {
+    $vals = $comHojeByBox[$boxName][$dateYmd] ?? null;
+    if ($vals && $vals['cnt'] > 0) {
+      $series[] = round($vals['sum'] / $vals['cnt'], 3);
+      $counts[] = (int)$vals['cnt'];
+    } else {
+      $series[] = null;
+      $counts[] = 0;
+    }
+  }
+  $comHojeBoxSeries[$boxName] = $series;
+  $comHojeBoxCount[$boxName]  = $counts;
 }
 
-/* 9) Preenche PESOS (SC) — valem para Hoje e Ontem (mesmo dia) */
-while ($r = $stW->fetch(PDO::FETCH_ASSOC)) {
-  $d  = $r['ref_date'];
-  $vn = (string)$r['variedade'];
-  $sc = is_numeric($r['sc']) ? (float)$r['sc'] : 0.0;
-  if ($sc <= 0) continue;
-
-  if (isset($idxByDateH[$d]) && isset($comHojeVarQty[$vn])) {
-    $comHojeVarQty[$vn][$idxByDateH[$d]] += $sc;
-  }
-  if (isset($idxByDateO[$d]) && isset($comOntemVarQty[$vn])) {
-    $comOntemVarQty[$vn][$idxByDateO[$d]] += $sc;
+$comOntemBoxSeries = [];
+$comOntemBoxCount  = [];
+foreach ($comBoxNames as $boxName) {
+  $series = [];
+  $counts = [];
+  foreach ($labelsCISO_O as $dateYmd) {
+    $vals = $comOntemByBox[$boxName][$dateYmd] ?? null;
+    if ($vals && $vals['cnt'] > 0) {
+      $series[] = round($vals['sum'] / $vals['cnt'], 3);
+      $counts[] = (int)$vals['cnt'];
+    } else {
+      $series[] = null;
+      $counts[] = 0;
+    }
   }
+  $comOntemBoxSeries[$boxName] = $series;
+  $comOntemBoxCount[$boxName]  = $counts;
 }
 
-/* 10) Ordena nomes de variedade como antes */
-natcasesort($comVarNames);
-$comVarNames = array_values($comVarNames);
-
 /* =============================================================================
  * 8) F18 — Big bag por Variedade (LINHAS por dia)
  * ========================================================================== */
 function payload_bigbag_var($payload) {
   return $payload['fazenda']['bigbag_por_variedade']
       ?? $payload['fazenda']['bigbag_por_variedades']
       ?? $payload['fazenda']['bigbag_variedade']
       ?? $payload['fazenda']['bigbag_variedades']
       ?? null;
 }
 
 $sqlF18 = "
   SELECT ref_date, payload_json
   FROM safra_entries
   WHERE ref_date >= :from AND ref_date < DATE_ADD(:to, INTERVAL 1 DAY)
     AND (:u1 = '' OR unidade = :u2)
   {$restrictUnitsSQL}
     AND COALESCE(
       JSON_EXTRACT(payload_json,'$.fazenda.bigbag_por_variedade'),
       JSON_EXTRACT(payload_json,'$.fazenda.bigbag_por_variedades'),
       JSON_EXTRACT(payload_json,'$.fazenda.bigbag_variedade'),
       JSON_EXTRACT(payload_json,'$.fazenda.bigbag_variedades')
     ) IS NOT NULL
   ORDER BY ref_date ASC, id ASC
 ";
@@ -1558,93 +1469,79 @@ $mediaF19 = $avgOf($series['f19_dia']);
           <div class="flex items-end">
             <div class="text-xs text-brand-muted">Dica: press F para sair/entrar em tela cheia.</div>
           </div>
         </div>
 
         <div class="flex flex-wrap items-center gap-2 mb-3">
           <input id="modalSearch" type="text" placeholder="Buscar..." class="border rounded-xl2 px-3 py-2 text-sm flex-1 min-w-[220px]" />
           <button id="modalSelAll" class="btn btn--compact rounded-pill text-sm">Selecionar todos</button>
           <button id="modalClear"  class="btn btn--compact rounded-pill text-sm">Limpar</button>
         </div>
 
         <div id="modalGridCols">
           <!-- colunas geradas via JS -->
         </div>
 
         <div class="mt-4 flex justify-end gap-2 actions-lg">
           <button id="modalCancel" class="btn btn--compact btn-lg border">Cancelar</button>
           <button id="modalApply"  class="btn btn--compact btn-lg bg-brand-primary text-white">Aplicar</button>
         </div>
       </div>
     </div>
   </div>
 
 <script>
 
-  // === Helpers globais (HOISTED) ===
-// Defina só uma vez no arquivo, no topo do <script>
-window.EXCLUDE_VARS = new Set(['Refugo','Resíduo','Residuo','Refugo/Resíduo']);
-
-function filterVarList(names){
-  names = names || [];
-  const out = [];
-  for (let i = 0; i < names.length; i++){
-    const v = (names[i] || '').trim();
-    if (!window.EXCLUDE_VARS.has(v)) out.push(v);
-  }
-  return out;
-}
-
   const THEME = { g1:'#9DBF21', g2:'#56A632', g3:'#63AA35', soft:'#cfe87a', red:'#EA0004', yellow:'#FFC107', text:'#1e1e1e' };
 
   document.getElementById('btnFull')?.addEventListener('click',()=>{
     if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
     else document.exitFullscreen();
   });
 
   // ===== Dados do PHP =====
   const labels  = <?php echo json_encode($labels, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const S       = <?php echo json_encode($series, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
 
   // Comercial HOJE
   const labelsC_H   = <?php echo json_encode($labelsC_H, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const avgPerSC_H  = <?php echo json_encode($avgPerSC_H, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const mediaSC_H   = <?php echo json_encode($mediaPeriodoSC_H, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const labelsCISO_H = <?php echo json_encode($labelsCISO_H, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
 
   // Comercial ONTEM
   const labelsC_O   = <?php echo json_encode($labelsC_O, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const avgPerSC_O  = <?php echo json_encode($avgPerSC_O, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const mediaSC_O   = <?php echo json_encode($mediaPeriodoSC_O, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const labelsCISO_O = <?php echo json_encode($labelsCISO_O, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
 
-  // ===== NOVO: Comercial ponderado por variedade =====
-  const comVarNames      = <?php echo json_encode($comVarNames, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
-  const comHojeVarPrice  = <?php echo json_encode($comHojeVarPrice, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
-  const comHojeVarQty    = <?php echo json_encode($comHojeVarQty, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
-  const comOntemVarPrice = <?php echo json_encode($comOntemVarPrice, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
-  const comOntemVarQty   = <?php echo json_encode($comOntemVarQty, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
+  // Comercial por caixa (series e contagens)
+  const comBoxNames       = <?php echo json_encode($comBoxNames, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
+  const comHojeBoxSeries  = <?php echo json_encode($comHojeBoxSeries, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
+  const comHojeBoxCount   = <?php echo json_encode($comHojeBoxCount, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
+  const comOntemBoxSeries = <?php echo json_encode($comOntemBoxSeries, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
+  const comOntemBoxCount  = <?php echo json_encode($comOntemBoxCount, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
 
   // ===== NOVO F18 (linhas)
   const f18VarNames     = <?php echo json_encode($f18VarNames, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const f18SeriesByVar  = <?php echo json_encode($f18SeriesByVar, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const f18TotalSeries  = <?php echo json_encode($f18TotalSeries, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const f18TotalMean    = <?php echo json_encode($f18TotalMean, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
 
   // NOVO: médias gerais (minutos)
   const mediaDesc  = <?php echo json_encode($mediaDesc, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>; // minutos
   const mediaParada = <?php echo json_encode($mediaParada, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>; // minutos
   const mediaAprov = <?php echo json_encode($mediaAprov, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
 
   const mediaPelada    = <?php echo json_encode($mediaPelada, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const mediaDefeitos  = <?php echo json_encode($mediaDefeitos, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const mediaUniform   = <?php echo json_encode($mediaUniform, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
 
   // TIPOS + SÉRIES POR TIPO (produção, fazenda e logística) — minutos
   const typesProd     = <?php echo json_encode(array_values($typesProd), JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const typesProdDesc = <?php echo json_encode(array_values($typesProdDesc), JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const typesFaz      = <?php echo json_encode(array_values($typesFaz),  JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
 
   // ===== LOGÍSTICA (2 veículos + média) — minutos
   const typesLogSel   = <?php echo json_encode(array_values($typesLogSel), JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const logTiposSel   = <?php echo json_encode($seriesLogTiposSel, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const logDailyMeanSel = <?php echo json_encode($logDailyMeanSel, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
@@ -1684,56 +1581,56 @@ function filterVarList(names){
   const totalMetaSafra = <?php echo json_encode($totalMetaSafra, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const diasComMeta    = <?php echo json_encode($diasComMeta, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const diasComDados   = <?php echo json_encode($diasComDados, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const diasAtingidos  = <?php echo json_encode($diasAtingidos, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const metaSeriesByDay = <?php echo json_encode($metaSeries, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const realSeriesByDay = <?php echo json_encode($series['p15_dia'], JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
 
   // ===== Estado base e refs dos gráficos
   const BASE = {
     labels: [...labels],
     labelsISO: [...labelsISO],
     S: JSON.parse(JSON.stringify(S)),
 
     // Comercial HOJE
     labelsC_H: [...labelsC_H],
     labelsCISO_H: [...labelsCISO_H],
     avgPerSC_H: [...avgPerSC_H],
     mediaSC_H: mediaSC_H,
 
     // Comercial ONTEM
     labelsC_O: [...labelsC_O],
     labelsCISO_O: [...labelsCISO_O],
     avgPerSC_O: [...avgPerSC_O],
     mediaSC_O: mediaSC_O,
 
-    // NOVO: Comercial ponderado por variedade
-    comVarNames: [...(comVarNames || [])],
-    comHojeVarPrice: JSON.parse(JSON.stringify(comHojeVarPrice || {})),
-    comHojeVarQty:   JSON.parse(JSON.stringify(comHojeVarQty   || {})),
-    comOntemVarPrice: JSON.parse(JSON.stringify(comOntemVarPrice || {})),
-    comOntemVarQty:   JSON.parse(JSON.stringify(comOntemVarQty   || {})),
+    // Comercial por caixa
+    comBoxNames: [...(comBoxNames || [])],
+    comHojeBoxSeries: JSON.parse(JSON.stringify(comHojeBoxSeries || {})),
+    comHojeBoxCount:  JSON.parse(JSON.stringify(comHojeBoxCount  || {})),
+    comOntemBoxSeries: JSON.parse(JSON.stringify(comOntemBoxSeries || {})),
+    comOntemBoxCount:  JSON.parse(JSON.stringify(comOntemBoxCount  || {})),
 
     typesProd: [...typesProd],
     typesProdDesc: [...typesProdDesc],
     typesFaz:  [...typesFaz],
 
     prodCarrTipos: JSON.parse(JSON.stringify(prodCarrTipos)),
     prodDescTipos: JSON.parse(JSON.stringify(prodDescTipos)),
     fazCarrTipos:  JSON.parse(JSON.stringify(fazCarrTipos)),
 
     // LOGÍSTICA (2 veículos + média)
     typesLogSel: [...typesLogSel],
     logTiposSel: JSON.parse(JSON.stringify(logTiposSel)),
     logDailyMeanSel: [...logDailyMeanSel],
     mediaLogSel: mediaLogSel,
 
     mediaParada: mediaParada,
 
     // médias diárias (entre tipos) em minutos
     prodCarrDailyMean: [...prodCarrDailyMean],
     prodDescDailyMean: [...prodDescDailyMean],
 
     // BRUTOS FAZENDA
     fazCarrRawSum: [...fazCarrRawSum],
     fazCarrRawCnt: [...fazCarrRawCnt],
 
@@ -2014,90 +1911,86 @@ function filterVarList(names){
     const to   = dTo   ? new Date(dTo)   : null;
     const keep = [];
     for(let i=0;i<allISO.length;i++){
       const d = new Date(allISO[i]);
       if ((from && d < from) || (to && d > to)) continue;
       keep.push(i);
     }
     return keep;
   }
   function sliceByIdx(arr, keepIdx){
     return keepIdx.map(i => (i>=0 && i<arr.length) ? arr[i] : null);
   }
 
 function avgNonNull(arr){
   let s = 0, c = 0;
   for (const v of (arr || [])) {
     if (v == null) continue;
     const n = Number(v);
     if (Number.isNaN(n)) continue;
     if (n <= 0) continue;        // <- ignora 0 e negativos
     s += n; c++;
   }
   return c ? (s / c) : null;
 }
 
-// ======== (NOVO) Helpers ponderados Comercial =========
-function weightedDailySeries(priceMap, qtyMap, varSel, len){
-  const out = new Array(len).fill(null);
-  for (let i=0;i<len;i++){
-    let ws=0, wq=0;
-    for (const v of varSel){
-      const pArr = priceMap[v] || [];
-      const qArr = qtyMap[v] || [];
-      const p = pArr[i]; const q = qArr[i];
-      if (p != null && !Number.isNaN(p) && Number(p) > 0 && q != null && !Number.isNaN(q) && Number(q) > 0){
-        ws += Number(p) * Number(q);
-        wq += Number(q);
-      }
+// ======== Helpers Comercial por caixa =========
+function combineBoxSeries(seriesMap, countMap, selectedBoxes, len){
+  const boxes = (selectedBoxes && selectedBoxes.length)
+    ? selectedBoxes
+    : Object.keys(seriesMap || {});
+  const sum = new Array(len).fill(0);
+  const weights = new Array(len).fill(0);
+  for (const box of boxes){
+    const serie = seriesMap?.[box] || [];
+    const counts = countMap?.[box] || [];
+    for (let i=0;i<len;i++){
+      const v = serie[i];
+      const c = counts[i];
+      if (v == null || Number.isNaN(v)) continue;
+      const cNum = Number(c);
+      if (Number.isNaN(cNum) || cNum <= 0) continue;
+      const vNum = Number(v);
+      if (Number.isNaN(vNum)) continue;
+      sum[i] += vNum * cNum;
+      weights[i] += cNum;
     }
-    out[i] = (wq > 0) ? (ws / wq) : null;
   }
-  return out;
+  const out = sum.map((s, i) => weights[i] > 0 ? (s / weights[i]) : null);
+  return { series: out, weights };
 }
 function weightedMean(series, weights){
   let ws=0, wq=0;
   for (let i=0;i<series.length;i++){
     const p = series[i], q = weights[i];
     if (p != null && !Number.isNaN(p) && Number(p) > 0 && q != null && !Number.isNaN(q) && Number(q) > 0){
       ws += Number(p) * Number(q);
       wq += Number(q);
     }
   }
   return (wq>0) ? (ws / wq) : null;
 }
-function flatQtyForSelection(qtyMap, varSel, len){
-  const out = new Array(len).fill(0);
-  for (const v of varSel){
-    const arr = qtyMap[v] || [];
-    for (let i=0;i<len;i++){
-      const q = arr[i];
-      if (q != null && !Number.isNaN(q) && Number(q) > 0) out[i] += Number(q);
-    }
-  }
-  return out;
-}
 function buildVarPicker(containerId, varNames, initialSel, onChange){
   const el = document.getElementById(containerId);
   if (!el) return;
   let state = new Set(initialSel && initialSel.length ? initialSel : varNames);
   function render(){
     el.innerHTML = '';
     varNames.forEach(vn=>{
       const btn = document.createElement('button');
       const active = state.has(vn);
       btn.type='button';
       btn.className = `px-2 py-1 rounded-full border ${active?'bg-brand-primary text-white border-brand-primary':'bg-white text-brand-text border-brand-line'}`;
       btn.textContent = vn;
       btn.setAttribute('aria-pressed', active ? 'true' : 'false');
       btn.addEventListener('click', ()=>{
         if (state.has(vn)) state.delete(vn); else state.add(vn);
         if (state.size === 0) state.add(vn); // nunca vazio
         render();
         onChange(Array.from(state));
       });
       el.appendChild(btn);
     });
     const allBtn = document.createElement('button');
     allBtn.type='button';
     allBtn.className='px-2 py-1 rounded-full border bg-white text-brand-text border-brand-line';
     allBtn.textContent='Todas';
@@ -2209,90 +2102,114 @@ if (can) {
   const v = kpi == null ? 0 : Math.max(0, Math.min(100, Number(kpi)));
   const g = new Chart(can, {
     type: 'doughnut',
     data: {
       labels: ['Atingido', 'Faltante'],
       datasets: [{
         data: [v, 100 - v],
         backgroundColor: [THEME.g2, hexToRgba(THEME.text, .08)],
         borderWidth: 0
       }]
     },
     options: {
       responsive: true,
       maintainAspectRatio: false,
       cutout: '70%',
       plugins: {
         legend: { display: false },
         tooltip: { enabled: false },
         noData: { text: 'Sem dados no período' }
       }
     }
   });
   can._chartInstance = g;
 }
 
-    // === Comercial HOJE (ponderado + preço diário no recorte) ===
+    // === Comercial HOJE (linhas por caixa) ===
     if (CH.comercial){
-      const sel = (window._comercialSelH && window._comercialSelH.length) ? window._comercialSelH : filterVarList(BASE.comVarNames);
-
-      // Séries completas
-      const priceFull = weightedDailySeries(BASE.comHojeVarPrice, BASE.comHojeVarQty, sel, BASE.labelsCISO_H.length); // R$/SC
-      const qtyFull   = flatQtyForSelection(BASE.comHojeVarQty,   sel, BASE.labelsCISO_H.length);                      // SC
+      const boxNames = BASE.comBoxNames || [];
+      const sel = (window._comercialSelH && window._comercialSelH.length) ? window._comercialSelH : boxNames;
+
+      const LCH = sliceByIdx(BASE.labelsC_H, keepH);
+      CH.comercial.data.labels = LCH;
+
+      const selSet = new Set(sel);
+      for (let i=0;i<boxNames.length;i++){
+        const box = boxNames[i];
+        const serieFull = BASE.comHojeBoxSeries?.[box] || [];
+        const data = sliceByIdx(serieFull, keepH);
+        const dataset = CH.comercial.data.datasets[i];
+        dataset.data = data;
+        dataset.hidden = !selSet.has(box);
+        dataset.label = box;
+        dataset.borderColor = colorForCaixa(box);
+      }
 
-      // Recorte
-      const LCH   = sliceByIdx(BASE.labelsC_H,  keepH);
-      const price = sliceByIdx(priceFull, keepH);
-      const qty   = sliceByIdx(qtyFull,   keepH);
+      const { series: combinedFull, weights: weightsFull } = combineBoxSeries(BASE.comHojeBoxSeries, BASE.comHojeBoxCount, sel, BASE.labelsC_H.length);
+      const price = sliceByIdx(combinedFull, keepH);
+      const qty   = sliceByIdx(weightsFull,  keepH);
 
       const hasW  = sumNumbers(qty) > 0;
       const medW  = hasW ? weightedMean(price, qty) : null;
 
-      CH.comercial.data.labels            = LCH;
-      CH.comercial.data.datasets[0].data  = price; // linha diária R$/SC
-      CH.comercial.data.datasets[1].data  = (medW!=null) ? new Array(LCH.length).fill(medW) : new Array(LCH.length).fill(null); // linha = média ponderada R$/SC
+      const meanDataset = CH.comercial.data.datasets[boxNames.length];
+      meanDataset.data = (medW!=null) ? new Array(LCH.length).fill(medW) : new Array(LCH.length).fill(null);
+      meanDataset.hidden = false;
       CH.comercial.update();
       setMetaMoney(document.getElementById('com-meta'), medW);
     }
 
-    // === Comercial ONTEM (ponderado + preço diário no recorte) ===
+    // === Comercial ONTEM (linhas por caixa) ===
     if (CH.comercialOntem){
-      const sel = (window._comercialSelO && window._comercialSelO.length) ? window._comercialSelO : filterVarList(BASE.comVarNames);
-
-      const priceFull = weightedDailySeries(BASE.comOntemVarPrice, BASE.comOntemVarQty, sel, BASE.labelsCISO_O.length);
-      const qtyFull   = flatQtyForSelection(BASE.comOntemVarQty,   sel, BASE.labelsCISO_O.length);
+      const boxNames = BASE.comBoxNames || [];
+      const sel = (window._comercialSelO && window._comercialSelO.length) ? window._comercialSelO : boxNames;
+
+      const LCO = sliceByIdx(BASE.labelsC_O, keepO);
+      CH.comercialOntem.data.labels = LCO;
+
+      const selSet = new Set(sel);
+      for (let i=0;i<boxNames.length;i++){
+        const box = boxNames[i];
+        const serieFull = BASE.comOntemBoxSeries?.[box] || [];
+        const data = sliceByIdx(serieFull, keepO);
+        const dataset = CH.comercialOntem.data.datasets[i];
+        dataset.data = data;
+        dataset.hidden = !selSet.has(box);
+        dataset.label = box;
+        dataset.borderColor = colorForCaixa(box);
+      }
 
-      const LCO   = sliceByIdx(BASE.labelsC_O,  keepO);
-      const price = sliceByIdx(priceFull, keepO);
-      const qty   = sliceByIdx(qtyFull,   keepO);
+      const { series: combinedFull, weights: weightsFull } = combineBoxSeries(BASE.comOntemBoxSeries, BASE.comOntemBoxCount, sel, BASE.labelsC_O.length);
+      const price = sliceByIdx(combinedFull, keepO);
+      const qty   = sliceByIdx(weightsFull,  keepO);
 
       const hasW  = sumNumbers(qty) > 0;
       const medW  = hasW ? weightedMean(price, qty) : null;
 
-      CH.comercialOntem.data.labels            = LCO;
-      CH.comercialOntem.data.datasets[0].data  = price; // linha diária R$/SC
-      CH.comercialOntem.data.datasets[1].data  = (medW!=null) ? new Array(LCO.length).fill(medW) : new Array(LCO.length).fill(null);
+      const meanDataset = CH.comercialOntem.data.datasets[boxNames.length];
+      meanDataset.data = (medW!=null) ? new Array(LCO.length).fill(medW) : new Array(LCO.length).fill(null);
+      meanDataset.hidden = false;
       CH.comercialOntem.update();
       setMetaMoney(document.getElementById('com-ontem-meta'), medW);
     }
 
     // ===== Logística (2 veículos + média) — HORAS
     if (CH.logistica){
       CH.logistica.data.labels = L;
 
       for (let i=0;i<BASE.typesLogSel.length;i++){
         const key = BASE.typesLogSel[i];
         const serie = seriesMinToHours(sliceByIdx(BASE.logTiposSel[key] || [], keep));
         CH.logistica.data.datasets[i].data = serie;
       }
       const idxMean = CH.logistica.data.datasets.length-1;
       CH.logistica.data.datasets[idxMean].data = seriesMinToHours(logMeanTwo_min);
 
       CH.logistica.update();
       setMetaHours('log-meta', mediaLogF);
     }
 
     // Qualidade
     if (CH.qPelada){
       CH.qPelada.data.labels = L;
       CH.qPelada.data.datasets[0].data = Sfil.q6_dia;
       CH.qPelada.data.datasets[1].data = new Array(L.length).fill(mediaPelF);
@@ -2606,162 +2523,192 @@ Chart.register(noDataPlugin);
       tooltip:{ callbacks:{ label:(ctx)=>{
         const vH = ctx.parsed.y;
         if (vH==null) return `${ctx.dataset.label}: -`;
         const min = Number(vH)*60;
         const hhmm = minutesToHHMM(min);
         return `${ctx.dataset.label}: ${vH.toLocaleString('pt-BR',{ minimumFractionDigits:2, maximumFractionDigits:3 })} h${hhmm?` (${hhmm})`:''}`;
       }}}
     },
     scales:{ y:{ beginAtZero:true, title:{ display:true, text:'Horas' } }, x:{ ticks:{ color: hexToRgba(THEME.text,.7) } } }
   };
 
   const typePalette = ['#0072B2','#E69F00','#D55E00','#CC79A7','#56B4E9','#009E73','#F0E442','#000000','#8A2BE2','#FF7F50','#3CB371','#DA70D6'];
   const colorForType = (name, isFaz=false, isDesc=false) => {
     const baseList = isFaz ? typesFaz : (isDesc ? typesProdDesc : typesProd);
     const idx = baseList.indexOf(name);
     return typePalette[Math.max(0, idx) % typePalette.length];
   };
   const colorForLog = (name) => {
     const idx = (BASE.typesLogSel || []).indexOf(name);
     return typePalette[Math.max(0, idx) % typePalette.length];
   };
   const colorForVar = (name) => {
     const idx = (BASE.f18VarNames || []).indexOf(name);
     return typePalette[Math.max(0, idx) % typePalette.length];
   };
+  const colorForCaixa = (name) => {
+    const idx = (comBoxNames || []).indexOf(name);
+    return typePalette[Math.max(0, idx) % typePalette.length];
+  };
 
-// ===== Comercial HOJE (linha diária + média ponderada R$/SC) =====
+// ===== Comercial HOJE (linha diária por caixa + média do recorte) =====
 (function(){
   const el = document.getElementById('chartComercialMedia');
   if (!el) return;
 
+  const boxNames = BASE.comBoxNames || [];
+  const datasets = boxNames.map(box => (
+    { ...mkLine(box, new Array(BASE.labelsC_H.length).fill(null), colorForCaixa(box), 'y', { borderWidth:3 }) }
+  ));
+  datasets.push(mkLine('Média selecionada (R$/SC)', new Array(BASE.labelsC_H.length).fill(null), THEME.g3, 'y', { pointRadius:0, borderDash:[6,4], borderWidth:3 }));
+
   CH.comercial = new Chart(el, {
-    data: { labels: BASE.labelsC_H, datasets: [
-      // Linha principal: preço diário por caixa (R$/SC)
-      mkLine('Preço diário (R$/SC)', new Array(BASE.labelsC_H.length).fill(null), THEME.g2, 'y', { borderWidth:3 }),
-      // Linha tracejada: média ponderada R$/SC (constante no recorte)
-      mkLine('Média ponderada (R$/SC)', new Array(BASE.labelsC_H.length).fill(null), THEME.g3, 'y', { pointRadius:0, borderDash:[6,4], borderWidth:3 }),
-    ]},
+    data: { labels: BASE.labelsC_H, datasets },
     options: {
       ...baseOpts(true),
       plugins:{
         ...baseOpts(true).plugins,
         tooltip:{ callbacks:{ label:(ctx)=>{
           const v = ctx.parsed.y;
           const txt = (v==null?'-':v.toLocaleString('pt-BR',{ minimumFractionDigits:2, maximumFractionDigits:3 }));
           return `${ctx.dataset.label}: R$ ${txt}/SC`;
         }}}
       },
       scales: {
         y:  { beginAtZero:true, position:'left',  title:{ display:true, text:'R$/SC' } }
       }
     }
   });
 
-  // Seletor e cálculo inicial (já ignorando Refugo/Resíduo)
-  const varNames = filterVarList(BASE.comVarNames);
-  buildVarPicker('comercialVarPicker', varNames, varNames, (sel) => {
-    window._comercialSelH = sel;
+  // Seletor e cálculo inicial por caixa
+  buildVarPicker('comercialVarPicker', boxNames, boxNames, (sel) => {
+    const selected = (sel && sel.length) ? sel : boxNames;
+    window._comercialSelH = selected;
 
     const idx = (window._keepIdxH && window._keepIdxH.length)
       ? window._keepIdxH
       : BASE.labelsCISO_H.map((_, i) => i);
 
-    // séries completas
-    const priceFull = weightedDailySeries(BASE.comHojeVarPrice, BASE.comHojeVarQty, sel, BASE.labelsCISO_H.length);
-    const qtyFull   = flatQtyForSelection   (BASE.comHojeVarQty,                     sel, BASE.labelsCISO_H.length);
+    const labels = sliceByIdx(BASE.labelsC_H, idx);
+    CH.comercial.data.labels = labels;
+
+    const selSet = new Set(selected);
+    for (let i=0;i<boxNames.length;i++){
+      const box = boxNames[i];
+      const serieFull = BASE.comHojeBoxSeries?.[box] || [];
+      const data = sliceByIdx(serieFull, idx);
+      const dataset = CH.comercial.data.datasets[i];
+      dataset.data = data;
+      dataset.hidden = !selSet.has(box);
+      dataset.label = box;
+      dataset.borderColor = colorForCaixa(box);
+    }
 
-    // aplica recorte
-    const price = sliceByIdx(priceFull, idx);
-    const qty   = sliceByIdx(qtyFull,   idx);
-    
-    // atualiza o gráfico com a série diária (R$/SC)
-    CH.comercial.data.datasets[0].data = price;
+    const { series: combinedFull, weights: weightsFull } = combineBoxSeries(BASE.comHojeBoxSeries, BASE.comHojeBoxCount, selected, BASE.labelsC_H.length);
+    const combined = sliceByIdx(combinedFull, idx);
+    const weights  = sliceByIdx(weightsFull,  idx);
 
-    // média ponderada R$/SC no recorte
-    const hasW = sumNumbers(qty) > 0;
-    const medW = hasW ? weightedMean(price, qty) : null;
+    const hasW = sumNumbers(weights) > 0;
+    const medW = hasW ? weightedMean(combined, weights) : null;
 
-    // linha horizontal constante com a média do recorte (mesmo número de pontos que o gráfico já tem)
-    CH.comercial.data.datasets[1].data = (medW != null)
-      ? new Array(CH.comercial.data.labels.length).fill(medW)
-      : new Array(CH.comercial.data.labels.length).fill(null);
+    const meanDataset = CH.comercial.data.datasets[boxNames.length];
+    meanDataset.data = (medW != null)
+      ? new Array(labels.length).fill(medW)
+      : new Array(labels.length).fill(null);
+    meanDataset.hidden = false;
 
     CH.comercial.update();
-    setMetaMoney(document.getElementById('com-meta'), medW); // mostra a média do recorte (sem fallback)
+    setMetaMoney(document.getElementById('com-meta'), medW);
   });
 })();
 
   // ===== Comercial ONTEM (inicia ponderado) =====
   // ===== Comercial ONTEM (linha diária + média ponderada R$/SC) =====
 (function(){
   const el = document.getElementById('chartComercialOntem');
   if (!el) return;
 
+  const boxNames = BASE.comBoxNames || [];
+  const datasets = boxNames.map(box => (
+    { ...mkLine(box, new Array(BASE.labelsC_O.length).fill(null), colorForCaixa(box), 'y', { borderWidth:3 }) }
+  ));
+  datasets.push(mkLine('Média selecionada (R$/SC)', new Array(BASE.labelsC_O.length).fill(null), THEME.g3, 'y', { pointRadius:0, borderDash:[6,4], borderWidth:3 }));
+
   CH.comercialOntem = new Chart(el, {
-    data: { labels: BASE.labelsC_O, datasets: [
-      mkLine('Preço diário (R$/SC)', new Array(BASE.labelsC_O.length).fill(null), THEME.g1, 'y', { borderWidth:3 }),
-      mkLine('Média ponderada (R$/SC)', new Array(BASE.labelsC_O.length).fill(null), THEME.g3, 'y', { pointRadius:0, borderDash:[6,4], borderWidth:3 }),
-    ]},
+    data: { labels: BASE.labelsC_O, datasets },
     options: {
       ...baseOpts(true),
       plugins:{
         ...baseOpts(true).plugins,
         tooltip:{ callbacks:{ label:(ctx)=>{
           const v = ctx.parsed.y;
           const txt = (v==null?'-':v.toLocaleString('pt-BR',{ minimumFractionDigits:2, maximumFractionDigits:3 }));
           return `${ctx.dataset.label}: R$ ${txt}/SC`;
         }}}
       },
       scales: {
         y:  { beginAtZero:true, position:'left',  title:{ display:true, text:'R$/SC' } }
       }
     }
   });
 
-  const varNames = filterVarList(BASE.comVarNames);
-  buildVarPicker('comercialOntemVarPicker', varNames, varNames, (sel) => {
-    window._comercialSelO = sel;
+  // Seletor e cálculo inicial por caixa (Ontem)
+  buildVarPicker('comercialOntemVarPicker', boxNames, boxNames, (sel) => {
+    const selected = (sel && sel.length) ? sel : boxNames;
+    window._comercialSelO = selected;
 
     const idx = (window._keepIdxO && window._keepIdxO.length)
       ? window._keepIdxO
       : BASE.labelsCISO_O.map((_, i) => i);
 
-    const priceFull = weightedDailySeries(BASE.comOntemVarPrice, BASE.comOntemVarQty, sel, BASE.labelsCISO_O.length);
-    const qtyFull   = flatQtyForSelection   (BASE.comOntemVarQty,                     sel, BASE.labelsCISO_O.length);
-
-    const price = sliceByIdx(priceFull, idx);
-    const qty   = sliceByIdx(qtyFull,   idx);
+    const labels = sliceByIdx(BASE.labelsC_O, idx);
+    CH.comercialOntem.data.labels = labels;
+
+    const selSet = new Set(selected);
+    for (let i=0;i<boxNames.length;i++){
+      const box = boxNames[i];
+      const serieFull = BASE.comOntemBoxSeries?.[box] || [];
+      const data = sliceByIdx(serieFull, idx);
+      const dataset = CH.comercialOntem.data.datasets[i];
+      dataset.data = data;
+      dataset.hidden = !selSet.has(box);
+      dataset.label = box;
+      dataset.borderColor = colorForCaixa(box);
+    }
 
-    CH.comercialOntem.data.datasets[0].data = price;
+    const { series: combinedFull, weights: weightsFull } = combineBoxSeries(BASE.comOntemBoxSeries, BASE.comOntemBoxCount, selected, BASE.labelsC_O.length);
+    const combined = sliceByIdx(combinedFull, idx);
+    const weights  = sliceByIdx(weightsFull,  idx);
 
-    const hasW = sumNumbers(qty) > 0;
-    const medW = hasW ? weightedMean(price, qty) : null;
+    const hasW = sumNumbers(weights) > 0;
+    const medW = hasW ? weightedMean(combined, weights) : null;
 
-    CH.comercialOntem.data.datasets[1].data = (medW != null)
-      ? new Array(CH.comercialOntem.data.labels.length).fill(medW)
-      : new Array(CH.comercialOntem.data.labels.length).fill(null);
+    const meanDataset = CH.comercialOntem.data.datasets[boxNames.length];
+    meanDataset.data = (medW != null)
+      ? new Array(labels.length).fill(medW)
+      : new Array(labels.length).fill(null);
+    meanDataset.hidden = false;
 
     CH.comercialOntem.update();
     setMetaMoney(document.getElementById('com-ontem-meta'), medW);
   });
 })();
 
   // ===== LOGÍSTICA (2 veículos + média) — HORAS
   (function(){
     const el = document.getElementById('chartLogistica');
     if (!el) return;
     CH.logistica = new Chart(el, { data:{ labels, datasets:[] }, options:{ ...hoursOpts, plugins:{ ...hoursOpts.plugins, legend:{ position:'bottom', labels:{ boxWidth:12 } } } } });
 
     const ds = (BASE.typesLogSel || []).map(k => ({ ...mkLine(k, seriesMinToHours(BASE.logTiposSel[k]||[]), colorForLog(k), 'y') }));
     ds.push(mkLine('Média (Carreta LS + Truck)', seriesMinToHours(BASE.logDailyMeanSel), THEME.g1, 'y', { pointRadius:0, borderDash:[6,4], borderWidth:3 } ));
     CH.logistica.data.datasets = ds; CH.logistica.update();
 
     setMetaHours('log-meta', BASE.mediaLogSel);
   })();
 
   // ===== Qualidade (3 gráficos)
   const mkQualOpts = () => ({
     ...baseOpts(true),
     plugins:{
       ...baseOpts(true).plugins,
       tooltip:{ callbacks:{ label:(ctx)=>{
 
EOF
)