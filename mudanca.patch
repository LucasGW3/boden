 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/safra_dashboard.php b/safra_dashboard.php
index 1fe6ec3aecc8464cfb77f3c65ae1441895bafecb..d9b34ba44bb6d462094c73c770837496ebe3479b 100644
--- a/safra_dashboard.php
+++ b/safra_dashboard.php
@@ -1572,70 +1572,50 @@ $mediaF19 = $avgOf($series['f19_dia']);
 
         <div class="mt-4 flex justify-end gap-2 actions-lg">
           <button id="modalCancel" class="btn btn--compact btn-lg border">Cancelar</button>
           <button id="modalApply"  class="btn btn--compact btn-lg bg-brand-primary text-white">Aplicar</button>
         </div>
       </div>
     </div>
   </div>
 
 <script>
 
   // === Helpers globais (HOISTED) ===
 // Defina só uma vez no arquivo, no topo do <script>
 window.EXCLUDE_VARS = new Set(['Refugo','Resíduo','Residuo','Refugo/Resíduo']);
 
 function filterVarList(names){
   names = names || [];
   const out = [];
   for (let i = 0; i < names.length; i++){
     const v = (names[i] || '').trim();
     if (!window.EXCLUDE_VARS.has(v)) out.push(v);
   }
   return out;
 }
 
-function dailyRevenue(priceMap, qtyMap, varSel, len){
-  const out = new Array(len).fill(null);
-  for (let i = 0; i < len; i++){
-    let sum = 0, any = false;
-    for (let k = 0; k < varSel.length; k++){
-      const v = varSel[k];
-      const pArr = (priceMap[v] || []);
-      const qArr = (qtyMap[v]   || []);
-      const p = pArr[i];
-      const q = qArr[i];
-      if (p != null && q != null && !Number.isNaN(p) && !Number.isNaN(q) && Number(q) > 0){
-        sum += Number(p) * Number(q);
-        any = true;
-      }
-    }
-    out[i] = any ? sum : null;
-  }
-  return out;
-}
-
   const THEME = { g1:'#9DBF21', g2:'#56A632', g3:'#63AA35', soft:'#cfe87a', red:'#EA0004', yellow:'#FFC107', text:'#1e1e1e' };
 
   document.getElementById('btnFull')?.addEventListener('click',()=>{
     if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
     else document.exitFullscreen();
   });
 
   // ===== Dados do PHP =====
   const labels  = <?php echo json_encode($labels, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const S       = <?php echo json_encode($series, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
 
   // Comercial HOJE
   const labelsC_H   = <?php echo json_encode($labelsC_H, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const avgPerSC_H  = <?php echo json_encode($avgPerSC_H, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const mediaSC_H   = <?php echo json_encode($mediaPeriodoSC_H, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const labelsCISO_H = <?php echo json_encode($labelsCISO_H, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
 
   // Comercial ONTEM
   const labelsC_O   = <?php echo json_encode($labelsC_O, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const avgPerSC_O  = <?php echo json_encode($avgPerSC_O, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const mediaSC_O   = <?php echo json_encode($mediaPeriodoSC_O, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
   const labelsCISO_O = <?php echo json_encode($labelsCISO_O, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
 
   // ===== NOVO: Comercial ponderado por variedade =====
   const comVarNames      = <?php echo json_encode($comVarNames, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); ?>;
@@ -2229,93 +2209,89 @@ if (can) {
   const v = kpi == null ? 0 : Math.max(0, Math.min(100, Number(kpi)));
   const g = new Chart(can, {
     type: 'doughnut',
     data: {
       labels: ['Atingido', 'Faltante'],
       datasets: [{
         data: [v, 100 - v],
         backgroundColor: [THEME.g2, hexToRgba(THEME.text, .08)],
         borderWidth: 0
       }]
     },
     options: {
       responsive: true,
       maintainAspectRatio: false,
       cutout: '70%',
       plugins: {
         legend: { display: false },
         tooltip: { enabled: false },
         noData: { text: 'Sem dados no período' }
       }
     }
   });
   can._chartInstance = g;
 }
 
-    // === Comercial HOJE (ponderado + receita R$ no recorte) ===
+    // === Comercial HOJE (ponderado + preço diário no recorte) ===
     if (CH.comercial){
       const sel = (window._comercialSelH && window._comercialSelH.length) ? window._comercialSelH : filterVarList(BASE.comVarNames);
 
       // Séries completas
       const priceFull = weightedDailySeries(BASE.comHojeVarPrice, BASE.comHojeVarQty, sel, BASE.labelsCISO_H.length); // R$/SC
       const qtyFull   = flatQtyForSelection(BASE.comHojeVarQty,   sel, BASE.labelsCISO_H.length);                      // SC
-      const revFull   = dailyRevenue(BASE.comHojeVarPrice, BASE.comHojeVarQty, sel, BASE.labelsCISO_H.length);         // R$
 
       // Recorte
       const LCH   = sliceByIdx(BASE.labelsC_H,  keepH);
       const price = sliceByIdx(priceFull, keepH);
       const qty   = sliceByIdx(qtyFull,   keepH);
-      const rev   = sliceByIdx(revFull,   keepH);
 
       const hasW  = sumNumbers(qty) > 0;
       const medW  = hasW ? weightedMean(price, qty) : null;
 
       CH.comercial.data.labels            = LCH;
-      CH.comercial.data.datasets[0].data  = rev; // barras = R$ total
+      CH.comercial.data.datasets[0].data  = price; // linha diária R$/SC
       CH.comercial.data.datasets[1].data  = (medW!=null) ? new Array(LCH.length).fill(medW) : new Array(LCH.length).fill(null); // linha = média ponderada R$/SC
       CH.comercial.update();
       setMetaMoney(document.getElementById('com-meta'), medW);
     }
 
-    // === Comercial ONTEM (ponderado + receita R$ no recorte) ===
+    // === Comercial ONTEM (ponderado + preço diário no recorte) ===
     if (CH.comercialOntem){
       const sel = (window._comercialSelO && window._comercialSelO.length) ? window._comercialSelO : filterVarList(BASE.comVarNames);
 
       const priceFull = weightedDailySeries(BASE.comOntemVarPrice, BASE.comOntemVarQty, sel, BASE.labelsCISO_O.length);
       const qtyFull   = flatQtyForSelection(BASE.comOntemVarQty,   sel, BASE.labelsCISO_O.length);
-      const revFull   = dailyRevenue(BASE.comOntemVarPrice, BASE.comOntemVarQty, sel, BASE.labelsCISO_O.length);
 
       const LCO   = sliceByIdx(BASE.labelsC_O,  keepO);
       const price = sliceByIdx(priceFull, keepO);
       const qty   = sliceByIdx(qtyFull,   keepO);
-      const rev   = sliceByIdx(revFull,   keepO);
 
       const hasW  = sumNumbers(qty) > 0;
       const medW  = hasW ? weightedMean(price, qty) : null;
 
       CH.comercialOntem.data.labels            = LCO;
-      CH.comercialOntem.data.datasets[0].data  = rev; // barras = R$ total
+      CH.comercialOntem.data.datasets[0].data  = price; // linha diária R$/SC
       CH.comercialOntem.data.datasets[1].data  = (medW!=null) ? new Array(LCO.length).fill(medW) : new Array(LCO.length).fill(null);
       CH.comercialOntem.update();
       setMetaMoney(document.getElementById('com-ontem-meta'), medW);
     }
 
     // ===== Logística (2 veículos + média) — HORAS
     if (CH.logistica){
       CH.logistica.data.labels = L;
 
       for (let i=0;i<BASE.typesLogSel.length;i++){
         const key = BASE.typesLogSel[i];
         const serie = seriesMinToHours(sliceByIdx(BASE.logTiposSel[key] || [], keep));
         CH.logistica.data.datasets[i].data = serie;
       }
       const idxMean = CH.logistica.data.datasets.length-1;
       CH.logistica.data.datasets[idxMean].data = seriesMinToHours(logMeanTwo_min);
 
       CH.logistica.update();
       setMetaHours('log-meta', mediaLogF);
     }
 
     // Qualidade
     if (CH.qPelada){
       CH.qPelada.data.labels = L;
       CH.qPelada.data.datasets[0].data = Sfil.q6_dia;
@@ -2631,181 +2607,165 @@ Chart.register(noDataPlugin);
         const vH = ctx.parsed.y;
         if (vH==null) return `${ctx.dataset.label}: -`;
         const min = Number(vH)*60;
         const hhmm = minutesToHHMM(min);
         return `${ctx.dataset.label}: ${vH.toLocaleString('pt-BR',{ minimumFractionDigits:2, maximumFractionDigits:3 })} h${hhmm?` (${hhmm})`:''}`;
       }}}
     },
     scales:{ y:{ beginAtZero:true, title:{ display:true, text:'Horas' } }, x:{ ticks:{ color: hexToRgba(THEME.text,.7) } } }
   };
 
   const typePalette = ['#0072B2','#E69F00','#D55E00','#CC79A7','#56B4E9','#009E73','#F0E442','#000000','#8A2BE2','#FF7F50','#3CB371','#DA70D6'];
   const colorForType = (name, isFaz=false, isDesc=false) => {
     const baseList = isFaz ? typesFaz : (isDesc ? typesProdDesc : typesProd);
     const idx = baseList.indexOf(name);
     return typePalette[Math.max(0, idx) % typePalette.length];
   };
   const colorForLog = (name) => {
     const idx = (BASE.typesLogSel || []).indexOf(name);
     return typePalette[Math.max(0, idx) % typePalette.length];
   };
   const colorForVar = (name) => {
     const idx = (BASE.f18VarNames || []).indexOf(name);
     return typePalette[Math.max(0, idx) % typePalette.length];
   };
 
-// ===== Comercial HOJE (barras = R$ total; linha = média ponderada R$/SC) =====
+// ===== Comercial HOJE (linha diária + média ponderada R$/SC) =====
 (function(){
   const el = document.getElementById('chartComercialMedia');
   if (!el) return;
 
   CH.comercial = new Chart(el, {
     data: { labels: BASE.labelsC_H, datasets: [
-      // Barras: valor total do dia (R$)
-      mkBar('Valor total do dia (R$)', new Array(BASE.labelsC_H.length).fill(null), THEME.g2, 'y1'),
+      // Linha principal: preço diário por caixa (R$/SC)
+      mkLine('Preço diário (R$/SC)', new Array(BASE.labelsC_H.length).fill(null), THEME.g2, 'y', { borderWidth:3 }),
       // Linha tracejada: média ponderada R$/SC (constante no recorte)
       mkLine('Média ponderada (R$/SC)', new Array(BASE.labelsC_H.length).fill(null), THEME.g3, 'y', { pointRadius:0, borderDash:[6,4], borderWidth:3 }),
     ]},
     options: {
       ...baseOpts(true),
       plugins:{
         ...baseOpts(true).plugins,
         tooltip:{ callbacks:{ label:(ctx)=>{
           const v = ctx.parsed.y;
-          if (ctx.dataset.yAxisID === 'y1') {
-            const txt = (v==null?'-':v.toLocaleString('pt-BR',{ minimumFractionDigits:2, maximumFractionDigits:2 }));
-            return `${ctx.dataset.label}: R$ ${txt}`;
-          } else {
-            const txt = (v==null?'-':v.toLocaleString('pt-BR',{ minimumFractionDigits:2, maximumFractionDigits:3 }));
-            return `${ctx.dataset.label}: R$ ${txt}/SC`;
-          }
+          const txt = (v==null?'-':v.toLocaleString('pt-BR',{ minimumFractionDigits:2, maximumFractionDigits:3 }));
+          return `${ctx.dataset.label}: R$ ${txt}/SC`;
         }}}
       },
       scales: {
-        y:  { beginAtZero:true, position:'left',  title:{ display:true, text:'R$/SC' } },
-        y1: { beginAtZero:true, position:'right', title:{ display:true, text:'R$ (total do dia)' }, grid:{ drawOnChartArea:false } }
+        y:  { beginAtZero:true, position:'left',  title:{ display:true, text:'R$/SC' } }
       }
     }
   });
 
   // Seletor e cálculo inicial (já ignorando Refugo/Resíduo)
   const varNames = filterVarList(BASE.comVarNames);
   buildVarPicker('comercialVarPicker', varNames, varNames, (sel) => {
     window._comercialSelH = sel;
 
     const idx = (window._keepIdxH && window._keepIdxH.length)
       ? window._keepIdxH
       : BASE.labelsCISO_H.map((_, i) => i);
 
     // séries completas
     const priceFull = weightedDailySeries(BASE.comHojeVarPrice, BASE.comHojeVarQty, sel, BASE.labelsCISO_H.length);
     const qtyFull   = flatQtyForSelection   (BASE.comHojeVarQty,                     sel, BASE.labelsCISO_H.length);
-    const revFull   = dailyRevenue          (BASE.comHojeVarPrice, BASE.comHojeVarQty, sel, BASE.labelsCISO_H.length);
 
     // aplica recorte
     const price = sliceByIdx(priceFull, idx);
     const qty   = sliceByIdx(qtyFull,   idx);
-    const rev   = sliceByIdx(revFull,   idx);
-
-    // atualiza o gráfico (barras = R$ total do dia)
-    CH.comercial.data.datasets[0].data = rev;
+    
+    // atualiza o gráfico com a série diária (R$/SC)
+    CH.comercial.data.datasets[0].data = price;
 
     // média ponderada R$/SC no recorte
     const hasW = sumNumbers(qty) > 0;
     const medW = hasW ? weightedMean(price, qty) : null;
 
     // linha horizontal constante com a média do recorte (mesmo número de pontos que o gráfico já tem)
     CH.comercial.data.datasets[1].data = (medW != null)
       ? new Array(CH.comercial.data.labels.length).fill(medW)
       : new Array(CH.comercial.data.labels.length).fill(null);
 
     CH.comercial.update();
     setMetaMoney(document.getElementById('com-meta'), medW); // mostra a média do recorte (sem fallback)
   });
 })();
 
   // ===== Comercial ONTEM (inicia ponderado) =====
- // ===== Comercial ONTEM (barras = R$ total; linha = média ponderada R$/SC) =====
+  // ===== Comercial ONTEM (linha diária + média ponderada R$/SC) =====
 (function(){
   const el = document.getElementById('chartComercialOntem');
   if (!el) return;
 
   CH.comercialOntem = new Chart(el, {
     data: { labels: BASE.labelsC_O, datasets: [
-      mkBar('Valor total do dia (R$)', new Array(BASE.labelsC_O.length).fill(null), THEME.g1, 'y1'),
+      mkLine('Preço diário (R$/SC)', new Array(BASE.labelsC_O.length).fill(null), THEME.g1, 'y', { borderWidth:3 }),
       mkLine('Média ponderada (R$/SC)', new Array(BASE.labelsC_O.length).fill(null), THEME.g3, 'y', { pointRadius:0, borderDash:[6,4], borderWidth:3 }),
     ]},
     options: {
       ...baseOpts(true),
       plugins:{
         ...baseOpts(true).plugins,
         tooltip:{ callbacks:{ label:(ctx)=>{
           const v = ctx.parsed.y;
-          if (ctx.dataset.yAxisID === 'y1') {
-            const txt = (v==null?'-':v.toLocaleString('pt-BR',{ minimumFractionDigits:2, maximumFractionDigits:2 }));
-            return `${ctx.dataset.label}: R$ ${txt}`;
-          } else {
-            const txt = (v==null?'-':v.toLocaleString('pt-BR',{ minimumFractionDigits:2, maximumFractionDigits:3 }));
-            return `${ctx.dataset.label}: R$ ${txt}/SC`;
-          }
+          const txt = (v==null?'-':v.toLocaleString('pt-BR',{ minimumFractionDigits:2, maximumFractionDigits:3 }));
+          return `${ctx.dataset.label}: R$ ${txt}/SC`;
         }}}
       },
       scales: {
-        y:  { beginAtZero:true, position:'left',  title:{ display:true, text:'R$/SC' } },
-        y1: { beginAtZero:true, position:'right', title:{ display:true, text:'R$ (total do dia)' }, grid:{ drawOnChartArea:false } }
+        y:  { beginAtZero:true, position:'left',  title:{ display:true, text:'R$/SC' } }
       }
     }
   });
 
   const varNames = filterVarList(BASE.comVarNames);
   buildVarPicker('comercialOntemVarPicker', varNames, varNames, (sel) => {
-  window._comercialSelO = sel;
+    window._comercialSelO = sel;
 
-  const idx = (window._keepIdxO && window._keepIdxO.length)
-    ? window._keepIdxO
-    : BASE.labelsCISO_O.map((_, i) => i);
+    const idx = (window._keepIdxO && window._keepIdxO.length)
+      ? window._keepIdxO
+      : BASE.labelsCISO_O.map((_, i) => i);
 
-  const priceFull = weightedDailySeries(BASE.comOntemVarPrice, BASE.comOntemVarQty, sel, BASE.labelsCISO_O.length);
-  const qtyFull   = flatQtyForSelection   (BASE.comOntemVarQty,                     sel, BASE.labelsCISO_O.length);
-  const revFull   = dailyRevenue          (BASE.comOntemVarPrice, BASE.comOntemVarQty, sel, BASE.labelsCISO_O.length);
+    const priceFull = weightedDailySeries(BASE.comOntemVarPrice, BASE.comOntemVarQty, sel, BASE.labelsCISO_O.length);
+    const qtyFull   = flatQtyForSelection   (BASE.comOntemVarQty,                     sel, BASE.labelsCISO_O.length);
 
-  const price = sliceByIdx(priceFull, idx);
-  const qty   = sliceByIdx(qtyFull,   idx);
-  const rev   = sliceByIdx(revFull,   idx);
+    const price = sliceByIdx(priceFull, idx);
+    const qty   = sliceByIdx(qtyFull,   idx);
 
-  CH.comercialOntem.data.datasets[0].data = rev;
+    CH.comercialOntem.data.datasets[0].data = price;
 
-  const hasW = sumNumbers(qty) > 0;
-  const medW = hasW ? weightedMean(price, qty) : null;
+    const hasW = sumNumbers(qty) > 0;
+    const medW = hasW ? weightedMean(price, qty) : null;
 
-  CH.comercialOntem.data.datasets[1].data = (medW != null)
-    ? new Array(CH.comercialOntem.data.labels.length).fill(medW)
-    : new Array(CH.comercialOntem.data.labels.length).fill(null);
+    CH.comercialOntem.data.datasets[1].data = (medW != null)
+      ? new Array(CH.comercialOntem.data.labels.length).fill(medW)
+      : new Array(CH.comercialOntem.data.labels.length).fill(null);
 
-  CH.comercialOntem.update();
-  setMetaMoney(document.getElementById('com-ontem-meta'), medW);
-});
+    CH.comercialOntem.update();
+    setMetaMoney(document.getElementById('com-ontem-meta'), medW);
+  });
 })();
 
   // ===== LOGÍSTICA (2 veículos + média) — HORAS
   (function(){
     const el = document.getElementById('chartLogistica');
     if (!el) return;
     CH.logistica = new Chart(el, { data:{ labels, datasets:[] }, options:{ ...hoursOpts, plugins:{ ...hoursOpts.plugins, legend:{ position:'bottom', labels:{ boxWidth:12 } } } } });
 
     const ds = (BASE.typesLogSel || []).map(k => ({ ...mkLine(k, seriesMinToHours(BASE.logTiposSel[k]||[]), colorForLog(k), 'y') }));
     ds.push(mkLine('Média (Carreta LS + Truck)', seriesMinToHours(BASE.logDailyMeanSel), THEME.g1, 'y', { pointRadius:0, borderDash:[6,4], borderWidth:3 } ));
     CH.logistica.data.datasets = ds; CH.logistica.update();
 
     setMetaHours('log-meta', BASE.mediaLogSel);
   })();
 
   // ===== Qualidade (3 gráficos)
   const mkQualOpts = () => ({
     ...baseOpts(true),
     plugins:{
       ...baseOpts(true).plugins,
       tooltip:{ callbacks:{ label:(ctx)=>{
         const v = ctx.parsed.y;
         const txt = (v==null?'-':v.toLocaleString('pt-BR',{ minimumFractionDigits:2, maximumFractionDigits:2 }));
         return `${ctx.dataset.label}: ${txt} %`;
       }}}
 
EOF
)